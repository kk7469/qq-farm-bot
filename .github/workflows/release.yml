name: release

# -------------------------------------------------
# 1ï¸âƒ£ è§¦å‘æ–¹å¼ï¼ˆæ‰‹åŠ¨ï¼‰
# -------------------------------------------------
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g. v1.2.3)'
        required: true
        default: 'v0.0.0'
      latest:
        description: 'Mark this release as latest? (true/false)'
        required: false
        default: 'true'
      prerelease:
        description: 'Is this a prerelease? (true/false)'
        required: false
        default: 'false'

# -------------------------------------------------
# 2ï¸âƒ£ éœ€è¦çš„æƒé™ï¼ˆç§æœ‰ä»“åº“è¯·æ‰“å¼€ï¼‰
# -------------------------------------------------
permissions:
  contents: write      # Release åˆ›å»º/æ›´æ–°
  packages: read       # ï¼ˆå¦‚æœä»¥åè¦ push Dockerï¼Œå¯æ”¹æˆ writeï¼‰

# -------------------------------------------------
# 3ï¸âƒ£ ç¬¬ä¸€ä¸ª Jobï¼šæ„å»ºå¹¶ä¸Šä¼  artifact
# -------------------------------------------------
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm package:release

      # DEBUGï¼šåˆ—å‡ºäº§ç‰©ç›®å½•ï¼ˆå¦‚æœè·¯å¾„ä¸å¯¹è¿™é‡Œä¼šæŠ¥é”™ï¼‰
      - name: List Built Artifacts (debug)
        run: |
          echo "ğŸ” åˆ—å‡º core/dist ç›®å½•"
          ls -R core/dist || echo "âš ï¸ core/dist ä¸å­˜åœ¨ï¼Œå¯èƒ½æ„å»ºè„šæœ¬è¾“å‡ºè·¯å¾„ä¸å¯¹"

      # -------------------------------------------------
      # ä¸Šä¼ å››ä¸ªå¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
      # -------------------------------------------------
      - name: Upload Windows
        uses: actions/upload-artifact@v4
        with:
          name: farm-win-x64
          path: ./core/dist/qq-farm-bot-win-x64.exe

      - name: Upload Linux
        uses: actions/upload-artifact@v4
        with:
          name: farm-linux-x64
          path: ./core/dist/qq-farm-bot-linux-x64

      - name: Upload macOS Intel
        uses: actions/upload-artifact@v4
        with:
          name: farm-mac-x64
          path: ./core/dist/qq-farm-bot-macos-x64

      - name: Upload macOS Apple Silicon
        uses: actions/upload-artifact@v4
        with:
          name: farm-mac-arm64
          path: ./core/dist/qq-farm-bot-macos-arm64

# -------------------------------------------------
# 4ï¸âƒ£ ç¬¬äºŒä¸ª Jobï¼šä¸‹è½½ artifact å¹¶å‘å¸ƒ Release
# -------------------------------------------------
  publish-release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout (needed for release action to have repo context)
        uses: actions/checkout@v4

      # ä¸‹è½½æ‰€æœ‰ä¹‹å‰ä¸Šä¼ çš„ artifactï¼Œæ”¾åˆ° ./artifacts ç›®å½•
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      # DEBUGï¼šç¡®è®¤æ–‡ä»¶ç»“æ„
      - name: Show downloaded artifact tree
        run: |
          echo "ğŸ“‚ ä¸‹è½½çš„æ–‡ä»¶ç»“æ„"
          ls -R artifacts

      # æ­£å¼å‘å¸ƒ Release
      - name: Create / Update Release
        uses: ncipollo/release-action@v1
        with:
          name: ${{ github.event.inputs.version }}
          tag: ${{ github.event.inputs.version }}
          body: "Release ${{ github.event.inputs.version }} (autoâ€‘generated by GitHub Actions)"
          token: ${{ secrets.GITHUB_TOKEN }}
          makeLatest: ${{ fromJSON(github.event.inputs.latest) }}
          prerelease: ${{ fromJSON(github.event.inputs.prerelease) }}
          allowUpdates: true
          # è¿™é‡Œçš„è·¯å¾„ç›¸å¯¹äºå·¥ä½œåŒºæ ¹ç›®å½•ï¼ˆå³ `artifacts/`ï¼‰
          artifacts: |
            artifacts/farm-win-x64/qq-farm-bot-win-x64.exe,
            artifacts/farm-linux-x64/qq-farm-bot-linux-x64,
            artifacts/farm-mac-x64/qq-farm-bot-macos-x64,
            artifacts/farm-mac-arm64/qq-farm-bot-macos-arm64
