name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g. v1.0.0)'
        required: true
        default: 'v0.0.0'
      latest:
        description: 'Mark this release as latest? (true/false)'
        required: false
        default: 'true'
      prerelease:
        description: 'Is this a prerelease? (true/false)'
        required: false
        default: 'false'

# -------------------------------------------------
# è®©å·¥ä½œæµæ‹¥æœ‰å†™ Release çš„æƒé™ï¼ˆç§åº“å¿…éœ€ï¼‰
# -------------------------------------------------
permissions:
  contents: write   # åˆ›å»º/æ›´æ–° Release
  packages: read    # ï¼ˆå¦‚æœåé¢è¦ push Dockerï¼‰

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ¯ å…³é”®ï¼špnpm ç‰ˆæœ¬è¦å’Œ package.json ä¸­çš„ packageManager å®Œå…¨ä¸€è‡´
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.30.2   # â† åŒæ­¥åˆ° package.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm package:release

      - name: List built artefacts (debug)
        run: |
          echo "ğŸ” æŸ¥çœ‹ core/dist ç›®å½•"
          ls -R core/dist || echo "âš ï¸ core/dist ä¸å­˜åœ¨ï¼Œè«‹æª¢æŸ¥ pnpm package:release è¼¸å‡ºè·¯å¾‘"

      # --------------------- ä¸Šä¼ å››ä¸ªå¹³å°çš„äº§ç‰© ---------------------
      - name: Upload Windows
        uses: actions/upload-artifact@v4
        with:
          name: farm-win-x64
          path: ./core/dist/qq-farm-bot-win-x64.exe

      - name: Upload Linux
        uses: actions/upload-artifact@v4
        with:
          name: farm-linux-x64
          path: ./core/dist/qq-farm-bot-linux-x64

      - name: Upload macOS Intel
        uses: actions/upload-artifact@v4
        with:
          name: farm-mac-x64
          path: ./core/dist/qq-farm-bot-macos-x64

      - name: Upload macOS Apple Silicon
        uses: actions/upload-artifact@v4
        with:
          name: farm-mac-arm64
          path: ./core/dist/qq-farm-bot-macos-arm64

  # -------------------------------------------------
  # å‘å¸ƒ Release
  # -------------------------------------------------
  publish-release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout (needed for release-action)
        uses: actions/checkout@v4

      - name: Download all artefacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts   # æ‰€æœ‰ artefact ä¼šæ”¾åœ¨ artifacts/<name>/ ä¸‹é¢

      - name: Show downloaded artefacts (debug)
        run: |
          echo "ğŸ“‚ artefacts ç›®éŒ„çµæ§‹"
          ls -R artifacts

      - name: Create / Update Release
        uses: ncipollo/release-action@v1
        with:
          name: ${{ github.event.inputs.version }}
          tag: ${{ github.event.inputs.version }}
          body: "Release ${{ github.event.inputs.version }} (autoâ€‘generated by GitHub Actions)"
          token: ${{ secrets.GITHUB_TOKEN }}
          makeLatest: ${{ fromJSON(github.event.inputs.latest) }}
          prerelease: ${{ fromJSON(github.event.inputs.prerelease) }}
          allowUpdates: true
          artifacts: |
            artifacts/farm-win-x64/qq-farm-bot-win-x64.exe,
            artifacts/farm-linux-x64/qq-farm-bot-linux-x64,
            artifacts/farm-mac-x64/qq-farm-bot-macos-x64,
            artifacts/farm-mac-arm64/qq-farm-bot-macos-arm64
