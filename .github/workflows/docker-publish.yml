name: ğŸ“¦ Build & Push Docker Image

on:
  # æ¨é€ä»»ä½• tagï¼ˆç¬¦åˆ v* è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼‰æ—¶è§¦å‘
  push:
    tags:
      - 'v*'          # ä¾‹: v1.2.3
  # ä¹Ÿå¯ä»¥åœ¨æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰æ—¶è¿è¡Œ
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntuâ€‘latest
    permissions:
      contents: read          # è¯»å–ä»£ç 
      packages: write         # ï¼ˆå¦‚æœç”¨ GitHub Packagesï¼‰è¿™é‡Œä¸éœ€è¦
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # æ‹‰å–å®Œæ•´å†å²ï¼Œä»¥ä¾¿æ‹¿åˆ° commit SHA
          fetch-depth: 0

      - name: è®¾ç½® QEMUï¼ˆç”¨äºå¤šå¹³å°æ„å»ºï¼Œå¯é€‰ï¼‰
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½® Docker Buildxï¼ˆæ”¯æŒå¤šå¹³å°ï¼‰ 
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: è¯»å– Git ä¿¡æ¯
        id: gitinfo
        run: |
          echo "tag=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse --short HEAD)"      >> $GITHUB_OUTPUT

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64   # å¯æ ¹æ®éœ€æ±‚åˆ å‡
          tags: |
            # æœ€æ–° tagï¼ˆæŒ‡å‘æ¯ä¸€æ¬¡æ„å»ºçš„é•œåƒï¼‰
            ${{ secrets.DOCKERHUB_USERNAME }}/qq-farm-bot:latest
            # è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼ˆä» tag è·å¾—ï¼‰
            ${{ secrets.DOCKERHUB_USERNAME }}/qq-farm-bot:${{ steps.gitinfo.outputs.tag }}
            # commit SHAï¼ˆå”¯ä¸€æ ‡è®°ï¼‰
            ${{ secrets.DOCKERHUB_USERNAME }}/qq-farm-bot:sha-${{ steps.gitinfo.outputs.sha }}
          cache-from: type=gha   # ä½¿ç”¨ GitHub Action cache åŠ é€Ÿåç»­æ„å»ºï¼ˆå¯é€‰ï¼‰
          cache-to: type=gha,mode=max
