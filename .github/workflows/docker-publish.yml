name: ğŸ“¦ Build & Push Docker Image

# è§¦å‘æ–¹å¼
on:
  push:
    tags:
      - 'v*'          # åªåœ¨è¯­ä¹‰åŒ– tag æ¨é€æ—¶æ‰§è¡Œ
  workflow_dispatch:

env:
  # æ‰“å¼€è°ƒè¯•ï¼ˆå¯é€‰ï¼‰
  ACTIONS_RUNNER_DEBUG: true
  ACTIONS_STEP_DEBUG: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # -------------------------------------------------
      # 1ï¸âƒ£ Checkout ä»£ç ï¼ˆå®Œæ•´å†å²ï¼Œæ‰èƒ½æ‹¿åˆ° tag & SHAï¼‰
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0               # å¿…é¡»æ‹‰å…¨éƒ¨å†å²

      # -------------------------------------------------
      # 2ï¸âƒ£ QEMU & Buildxï¼ˆæ”¯æŒå¤šå¹³å°ï¼‰
      # -------------------------------------------------
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -------------------------------------------------
      # 3ï¸âƒ£ Docker Hub ç™»å½•
      # -------------------------------------------------
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -------------------------------------------------
      # 4ï¸âƒ£ å– Git ä¿¡æ¯ï¼ˆtag & short SHAï¼‰
      # -------------------------------------------------
      - name: Get git information
        id: gitinfo
        run: |
          # ---- tag -------------------------------------------------
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || true)
          if [[ -z "$TAG" ]]; then
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ° tagï¼Œä½¿ç”¨ latest ä½œä¸º fallback"
            TAG="latest"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # ---- short SHA -------------------------------------------
          SHA=$(git rev-parse --short HEAD)
          echo "sha=$SHA" >> $GITHUB_OUTPUT

          # ---- è¾“å‡ºè°ƒè¯•ä¿¡æ¯ ---------------------------------------
          echo "ğŸ” Git info => tag=$TAG  sha=$SHA"

      # -------------------------------------------------
      # 5ï¸âƒ£ **verify** â€“ éªŒè¯é•œåƒå‘½åæ˜¯å¦åˆæ³•
      # -------------------------------------------------
      - name: Verify image name & tags
        id: verify
        run: |
          REPO="${{ secrets.DOCKERHUB_USERNAME }}/qq-farm-bot"
          TAG="${{ steps.gitinfo.outputs.tag }}"
          SHA="${{ steps.gitinfo.outputs.sha }}"

          # æ£€æŸ¥ repo å¿…é¡»å…¨å°å†™
          if [[ "$REPO" != "$(echo "$REPO" | tr '[:upper:]' '[:lower:]')" ]]; then
            echo "âŒ Repository name must be all lowerâ€‘case. Got: $REPO"
            exit 1
          fi

          # æ£€æŸ¥ tag æ˜¯å¦ç¬¦åˆ Docker tag è§„èŒƒï¼ˆå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€ç‚¹ã€çŸ­æ¨ªçº¿ï¼Œä¸”ä¸ä»¥ . å¼€å¤´ï¼Œæœ€é•¿ 128 å­—èŠ‚ï¼‰
          if [[ ! "$TAG" =~ ^[a-zA-Z0-9_.-]+$ ]]; then
            echo "âŒ Invalid tag format: $TAG"
            exit 1
          fi

          # è¾“å‡ºä¾›åé¢æ­¥éª¤ä½¿ç”¨çš„ç¯å¢ƒå˜é‡
          echo "IMAGE_REPO=$REPO" >> $GITHUB_ENV
          echo "IMAGE_TAG=$TAG"   >> $GITHUB_ENV
          echo "IMAGE_SHA=$SHA"   >> $GITHUB_ENV

          echo "âœ… Verify passed â†’ $REPO:$TAG / sha-$SHA"

      # -------------------------------------------------
      # 6ï¸âƒ£ Build & Push é•œåƒ
      # -------------------------------------------------
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_REPO }}:latest
            ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}
            ${{ env.IMAGE_REPO }}:sha-${{ env.IMAGE_SHA }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -------------------------------------------------
      # 7ï¸âƒ£ æœ€åè¾“å‡ºæˆåŠŸä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
      # -------------------------------------------------
      - name: Show final image URLs
        run: |
          echo "ğŸš€ é•œåƒå·²æ¨é€è‡³ Docker Hub"
          echo "  - latest:   https://hub.docker.com/r/${{ env.IMAGE_REPO }}/tags?page=1&name=latest"
          echo "  - tag:      https://hub.docker.com/r/${{ env.IMAGE_REPO }}/tags?page=1&name=${{ env.IMAGE_TAG }}"
          echo "  - sha:      https://hub.docker.com/r/${{ env.IMAGE_REPO }}/tags?page=1&name=sha-${{ env.IMAGE_SHA }}"
