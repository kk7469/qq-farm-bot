name: Build & Publish Docker Image

# -------------------------------------------------
# 触发条件
# -------------------------------------------------
on:
  push:
    branches:
      - main                         # 推送 main 时构建
    tags:
      - 'v*'                         # 打 tag（如 v1.0.0）时构建
  workflow_dispatch:                # 手动触发

# -------------------------------------------------
# 全局变量（只需要改这里的两行即可适配不同结构）
# -------------------------------------------------
env:
  # Docker Hub 镜像仓库（用户名已经改为 leywu）
  IMAGE_NAME: leywu/qq-farm-bot

  # Dockerfile 所在路径（相对于仓库根目录）
  DOCKERFILE_PATH: core/Dockerfile   # ← 这里改为 core/Dockerfile

  # Build Context：Dockerfile 能访问的根目录
  # 为了让 Dockerfile 中的 COPY/ADD 能找到项目文件，使用同一目录
  BUILD_CONTEXT: core                # ← 同样指向 core/
  jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write   # 如不使用 GH Packages 可去掉
      id-token: write   # 如不需要 OIDC 可去掉

    steps:
      # -------------------------------------------------
      # 1️⃣ 检出代码（完整历史，便于读取 tag/sha）
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 拉取完整历史，tag / SHA 解析需要

      # -------------------------------------------------
      # 2️⃣ QEMU（支持多平台交叉编译）
      # -------------------------------------------------
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      # -------------------------------------------------
      # 3️⃣ Buildx（已去除已废弃的 install 参数）
      # -------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        # 默认行为：如果系统里没有 builder，就自动创建一个
        # 如想自定义 builder 名称，可加入：
        #   env:
        #     BUILDX_BUILDER: mybuilder

      # -------------------------------------------------
      # 4️⃣ 登录 Docker Hub（凭证来自 Secrets）
      # -------------------------------------------------
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}   # 必须是 leywu
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -------------------------------------------------
      # 5️⃣ 计算镜像标签（latest、short‑sha、git‑tag）
      # -------------------------------------------------
      - name: Set image tags
        id: meta
        run: |
          # 默认标签：latest + 短 SHA
          TAGS="${{ env.IMAGE_NAME }}:latest,${{ env.IMAGE_NAME }}:${GITHUB_SHA::7}"
          
          # 如果是 tag 触发，则使用 tag 名称（默认去掉前缀 v）
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            TAG_NAME=$(echo "$TAG_NAME" | sed -e 's/^v//')
            TAGS="${{ env.IMAGE_NAME }}:${TAG_NAME},${{ env.IMAGE_NAME }}:latest"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      # -------------------------------------------------
      # 6️⃣ 构建并推送镜像
      # -------------------------------------------------
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # 明确指定 Dockerfile 与 build context
          file: ${{ env.DOCKERFILE_PATH }}
          context: ${{ env.BUILD_CONTEXT }}

          push: true
          # 多平台（如不需要 ARM64 可改为 linux/amd64）
          platforms: linux/amd64,linux/arm64

          tags: ${{ steps.meta.outputs.tags }}

          # 可选缓存：使用 Docker Hub 作为缓存仓库，加速后续构建
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache,mode=max

cho "Image digest: ${{ steps.build-and-push.outputs.digest }}
