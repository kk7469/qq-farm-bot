# .github/workflows/docker-publish.yml
name: ğŸ“¦ Build & Push Docker Image

# -------------------------------------------------
# è§¦å‘æ–¹å¼
# -------------------------------------------------
on:
  # åªåœ¨å¸¦æœ‰ v å‰ç¼€çš„ tag è¢«æ¨é€æ—¶è¿è¡Œï¼ˆå¦‚ v1.2.3ï¼‰
  push:
    tags:
      - 'v*'
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨åœ¨ UI è§¦å‘ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
  workflow_dispatch:

# -------------------------------------------------
# è®©æ—¥å¿—æ›´è¯¦ç»†ï¼Œä¾¿äºæ’é”™ï¼ˆå¯é€‰ï¼‰
# -------------------------------------------------
env:
  ACTIONS_RUNNER_DEBUG: true
  ACTIONS_STEP_DEBUG: true

# -------------------------------------------------
# ä»»åŠ¡
# -------------------------------------------------
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    # åªéœ€è¦è¯»æºç çš„æƒé™ï¼Œç™»å½• Dockerâ€¯Hub ç”¨ secret
    permissions:
      contents: read

    steps:
      # -------------------------------------------------
      # 1ï¸âƒ£ Checkout ä»£ç ï¼ˆå¿…é¡»å®Œæ•´å†å²ï¼Œæ‰èƒ½æ‹¿åˆ° tag & SHAï¼‰
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # æ‹‰å–å®Œæ•´ historyï¼Œgit describe æ‰èƒ½å·¥ä½œ

      # -------------------------------------------------
      # 2ï¸âƒ£ QEMU & Buildxï¼ˆæ”¯æŒå¤šå¹³å°ï¼šamd64 + arm64ï¼‰
      # -------------------------------------------------
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -------------------------------------------------
      # 3ï¸âƒ£ ç™»å½• Docker Hub
      # -------------------------------------------------
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -------------------------------------------------
      # 4ï¸âƒ£ è¯»å– Git ä¿¡æ¯ï¼ˆtagã€çŸ­ SHAï¼‰
      # -------------------------------------------------
      - name: Get Git information
        id: gitinfo
        run: |
          # ---- tag -------------------------------------------------
          TAG=$(git describe --tags --abbrev=0)    # è¿™é‡Œçš„ TAG å¿…é¡»æ˜¯ vX.Y.Z å½¢å¼
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # ---- short SHA -------------------------------------------
          SHA=$(git rev-parse --short HEAD)
          echo "sha=$SHA" >> $GITHUB_OUTPUT

          echo "ğŸ” Git info => tag=$TAG  sha=$SHA"

      # -------------------------------------------------
      # 5ï¸âƒ£ ç”ŸæˆçœŸå®çš„é•œåƒåç§°ï¼ˆç»Ÿä¸€æ”¾åœ¨ç¯å¢ƒå˜é‡é‡Œï¼Œåé¢å¤ç”¨ï¼‰
      # -------------------------------------------------
      - name: Prepare image name & tags
        id: img
        run: |
          REPO="${{ secrets.DOCKERHUB_USERNAME }}/qq-farm-bot"
          TAG="${{ steps.gitinfo.outputs.tag }}"
          SHA="${{ steps.gitinfo.outputs.sha }}"

          # --- åŸºæœ¬æ ¡éªŒ -------------------------------------------------
          # å¿…é¡»å…¨å°å†™
          if [[ "$REPO" != "$(echo "$REPO" | tr '[:upper:]' '[:lower:]')" ]]; then
            echo "âŒ Repository name must be lowercase"
            exit 1
          fi
          # Docker tag åªèƒ½ä½¿ç”¨å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€ç‚¹ã€çŸ­æ¨ªçº¿
          if [[ ! "$TAG" =~ ^[a-zA-Z0-9_.-]+$ ]]; then
            echo "âŒ Tag \"$TAG\" contains illegal characters for Docker"
            exit 1
          fi

          # --- å¯¼å‡ºç»™åç»­æ­¥éª¤ä½¿ç”¨ ---------------------------------------
          echo "image_repo=$REPO"   >> $GITHUB_OUTPUT
          echo "image_tag=$TAG"     >> $GITHUB_OUTPUT
          echo "image_sha=$SHA"     >> $GITHUB_OUTPUT

          echo "âœ… Image will be pushed as:"
          echo "   $REPO:latest"
          echo "   $REPO:$TAG"
          echo "   $REPO:sha-$SHA"

      # -------------------------------------------------
      # 6ï¸âƒ£ Build & Push é•œåƒï¼ˆä¸€æ¬¡æ„å»ºï¼Œå¤šæ ‡ç­¾ä¸€æ¬¡ pushï¼‰
      # -------------------------------------------------
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .                     # Dockerfile é»˜è®¤åœ¨æ ¹ç›®å½•
          file: ./Dockerfile
          push: true                     # çœŸæ­£æ¨é€
          platforms: linux/amd64,linux/arm64   # éœ€è¦çš„å¹³å°
          tags: |
            ${{ steps.img.outputs.image_repo }}:latest
            ${{ steps.img.outputs.image_repo }}:${{ steps.img.outputs.image_tag }}
            ${{ steps.img.outputs.image_repo }}:sha-${{ steps.img.outputs.image_sha }}
          cache-from: type=gha           # å¤ç”¨ GitHub ç¼“å­˜ï¼ŒåŠ é€Ÿåç»­æ„å»º
          cache-to: type=gha,mode=max

      # -------------------------------------------------
      # 7ï¸âƒ£ è¾“å‡ºç»“æœï¼ˆå¯é€‰ï¼Œå¸®åŠ©ä½ å¿«é€Ÿå¤åˆ¶æ‹‰å–å‘½ä»¤ï¼‰
      # -------------------------------------------------
      - name: Show final image URLs
        run: |
          REPO="${{ steps.img.outputs.image_repo }}"
          TAG="${{ steps.img.outputs.image_tag }}"
          SHA="${{ steps.img.outputs.image_sha }}"

          echo "ğŸš€ é•œåƒå·²æˆåŠŸæ¨é€åˆ° Docker Hub"
          echo "   latest : docker pull $REPO:latest"
          echo "   tag    : docker pull $REPO:$TAG"
          echo "   sha    : docker pull $REPO:sha-$SHA"
          echo ""
          echo "åœ¨æµè§ˆå™¨æ‰“å¼€æŸ¥çœ‹ï¼š"
          echo "   https://hub.docker.com/r/$REPO/tags"
